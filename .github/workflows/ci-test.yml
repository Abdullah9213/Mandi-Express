# Phase III: CI Pipeline for dev -> test merges
# Runs: Model Retraining Test + CML Report

name: CI - Test Branch (Model Training)

on:
  pull_request:
    branches: [test]

env:
  DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

jobs:
  model-training-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pandas scikit-learn joblib mlflow dagshub dvc

      - name: Setup DVC
        run: |
          dvc remote modify dagshub --local auth basic
          dvc remote modify dagshub --local user ${{ secrets.DAGSHUB_USERNAME }}
          dvc remote modify dagshub --local password ${{ secrets.DAGSHUB_TOKEN }}

      - name: Pull data with DVC
        run: |
          dvc pull || echo "DVC pull failed - using local data"

      - name: Train Model
        run: |
          python scripts/train_model.py
        env:
          DATA_PATH: include/processed_combined.csv
          MODEL_PATH: models/mandi_pipeline.pkl

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/mandi_pipeline.pkl

  cml-report:
    runs-on: ubuntu-latest
    needs: model-training-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Install dependencies
        run: |
          pip install pandas scikit-learn joblib mlflow

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models/

      - name: Generate CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/generate_cml_report.py > report.md
          cml comment create report.md
