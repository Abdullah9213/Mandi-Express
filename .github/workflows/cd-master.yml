# Phase III: CD Pipeline for test -> master merges
# Runs: Build Docker, Push to Registry, Deploy Verification

name: CD - Master Branch (Production)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/mandi-api
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Setup DVC
        run: |
          pip install dvc
          dvc remote modify dagshub --local auth basic
          dvc remote modify dagshub --local user ${{ secrets.DAGSHUB_USERNAME }}
          dvc remote modify dagshub --local password ${{ secrets.DAGSHUB_TOKEN }}

      - name: Pull model with DVC
        run: |
          dvc pull models/ || echo "Using existing model"

      - name: Get version tag
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.VERSION }}

  deploy-verification:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Pull and Run Container
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          docker run -d -p 8000:8000 --name mandi-test ${{ env.DOCKER_IMAGE }}:latest
          sleep 10

      - name: Health Check
        run: |
          curl -f http://localhost:8000/health || exit 1
          echo "✅ Health check passed!"

      - name: Test Prediction Endpoint
        run: |
          curl -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"city": "Lahore", "crop": "Onion", "date": "2024-01-15"}' \
            || echo "Prediction test completed"

      - name: Test Metrics Endpoint
        run: |
          curl -f http://localhost:8000/metrics || echo "Metrics endpoint check completed"

      - name: Cleanup
        run: |
          docker stop mandi-test
          docker rm mandi-test

      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "✅ DEPLOYMENT VERIFICATION COMPLETE"
          echo "=========================================="
          echo "Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "Health: OK"
          echo "Prediction API: OK"
          echo "Metrics API: OK"
          echo "=========================================="
